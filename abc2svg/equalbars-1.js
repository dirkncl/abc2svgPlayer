// abc2svg - ABC to SVG translator
// @source: https://chiselapp.com/user/moinejf/repository/abc2svg
// Copyright (C) 2014-2018 Jean-Francois Moine - LGPL3+
abc2svg.equalbars={output_music:function(of){this.equalbars_d=0;of()},set_fmt:function(of,cmd,param,lock){if(cmd=="equalbars")this.cfmt().equalbars=this.get_bool(param);else of(cmd,param,lock)},set_sym_glue:function(of,width){var C=abc2svg.C,s,s2,w,i,n,x,g,t,t0,bars=[],tsfirst=this.get_tsfirst();of(width);if(!this.cfmt().equalbars)return;for(s=tsfirst;s;s=s.ts_next){if(!s.seqst)continue;switch(s.type){default:s2=s;continue;case C.GRACE:case C.MREST:case C.NOTE:case C.REST:case C.SPACE:break}break}if(!s)return;t0=t=s.time;while(1){if(!s.ts_next){bars.push([s,s.time-t]);t=s.time;if(s.dur)t+=s.dur;break}if(s.type==C.BAR&&s.seqst){bars.push([s,s.time-t]);t=s.time}s=s.ts_next}n=bars.length;if(n==0)return;for(s=s2.ts_next;s;s=s.ts_next){if(s.seqst)break}x=s.type==C.GRACE?s.extra.x:s.x;d=this.equalbars_d;if(!d)d=this.equalbars_d=x;w=(width-d)/(t-t0);for(i=0;i<n;i++){s=bars[i][0];f=w*bars[i][1]/(s.x-x);for(s2=s2.ts_next;s2!=s;s2=s2.ts_next){if(s2.type==C.GRACE){for(g=s2.extra;g;g=g.next)g.x=d+(g.x-x)*f}else if(s2.x){s2.x=d+(s2.x-x)*f}}d+=w*bars[i][1];x=s2.x;while(1){s2.x=d;if(!s2.ts_next||s2.ts_next.seqst)break;s2=s2.ts_next}if(!s2)break}}};abc2svg.modules.hooks.push("get_bool",["output_music","abc2svg.equalbars.output_music"],["set_format","abc2svg.equalbars.set_fmt"],["set_sym_glue","abc2svg.equalbars.set_sym_glue"]);abc2svg.modules.equalbars.loaded=true;
