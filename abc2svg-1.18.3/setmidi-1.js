// abc2svg - ABC to SVG translator
// @source: https://chiselapp.com/user/moinejf/repository/abc2svg
// Copyright (C) 2014-2018 Jean-Francois Moine - LGPL3+
function AbcMIDI(){var C=abc2svg.C;AbcMIDI.prototype.add=function(s,voice_tb){var scale=new Int8Array([0,2,4,5,7,9,11]),bmap=new Int8Array(7),map=new Int8Array(70),tie_map,tie_time,v,transp;function bar_map(){for(var j=0;j<10;j++)for(var i=0;i<7;i++)map[j*7+i]=bmap[i]}function key_map(s){for(var i=0;i<7;i++)bmap[i]=0;switch(s.k_sf){case 7:bmap[6]=1;case 6:bmap[2]=1;case 5:bmap[5]=1;case 4:bmap[1]=1;case 3:bmap[4]=1;case 2:bmap[0]=1;case 1:bmap[3]=1;break;case-7:bmap[3]=-1;case-6:bmap[0]=-1;case-5:bmap[4]=-1;case-4:bmap[1]=-1;case-3:bmap[5]=-1;case-2:bmap[2]=-1;case-1:bmap[6]=-1;break}bar_map()}function pit2midi(p,a){if(a)map[p]=a==3?0:a;return(p/7|0)*12+scale[p%7]+(tie_time[p]?tie_map[p]:map[p])}for(v=0;v<voice_tb.length;v++){if(!voice_tb[v].sym)continue;s=voice_tb[v].clef;if(!s.clef_octave||s.clef_oct_transp)transp=0;else transp=s.clef_octave;key_map(voice_tb[v].key);vloop(v)}function vloop(v){var i,g,p,note,s=voice_tb[v].sym,vtime=s.time,rep_tie_map=[];tie_map=[];tie_time=[];while(s){if(s.time>vtime){bar_map();vtime=s.time}if(s.dur)vtime=s.time+s.dur;switch(s.type){case C.BAR:if(s.text){if(s.text[0]=="1"){rep_tie_map=[];rep_tie_time=[];for(i=0;i<tie_map.length;i++)rep_tie_map[i]=tie_map[i]}else if(rep_tie_map.length!=0){tie_map=[];tie_time=[];for(i=0;i<rep_tie_map.length;i++){tie_map[i]=rep_tie_map[i];tie_time[i]=s.time}}}if(!s.invis)bar_map();break;case C.CLEF:if(!s.clef_octave||s.clef_oct_transp)transp=0;else transp=s.clef_octave;break;case C.GRACE:for(g=s.extra;g;g=g.next){if(!g.type!=C.NOTE)continue;for(i=0;i<=g.nhd;i++){note=g.notes[i];p=note.pit+19+transp;note.midi=pit2midi(p,note.acc)}}break;case C.KEY:key_map(s);break;case C.NOTE:for(i=0;i<=s.nhd;i++){note=s.notes[i];p=note.pit+19+transp;if(tie_time[p]){if(s.time>tie_time[p]){delete tie_map[p];delete tie_time[p]}}note.midi=pit2midi(p,note.acc);if(note.ti1){tie_map[p]=map[p];tie_time[p]=s.time+s.dur}}break}s=s.next}}}}
