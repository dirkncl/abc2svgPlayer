// abc2svg - ABC to SVG translator
// @source: https://chiselapp.com/user/moinejf/repository/abc2svg
// Copyright (C) 2014-2018 Jean-Francois Moine - LGPL3+
abc2svg.MIDI={do_midi:function(parm){var pits=new Int8Array([0,0,1,2,2,3,3,4,5,5,6,6]),accs=new Int8Array([0,1,0,-1,0,0,1,0,-1,0,-1,0]);function tonote(p){var pit=Number(p);if(isNaN(pit))return;p=(pit/12|0)*7-19;pit=pit%12;p+=pits[pit];note={pit:p};if(accs[pit])note.acc=accs[pit];return note}function norm(p){var a=p.match(/^([_^=]*)([A-Ga-g])([,']*)$/);if(!a)return;if(p.match(/[A-Z]/)){p=p.toLowerCase();if(p.indexOf("'")>0)p=p.replace("'","");else p+=","}return p}var n,v,maps=this.get_maps(),a=parm.split(/\s+/);switch(a[1]){case"channel":if(a[2]!="10")break;this.set_v_param("midictl","0 1");break;case"drummap":if(this.cfmt().sound!="play")break;n=norm(a[2]);v=tonote(a[3]);if(!n||!v){this.syntax(1,this.errs.bad_val,"%%MIDI drummap");break}if(!maps.MIDIdrum)maps.MIDIdrum={};maps.MIDIdrum[n]=[null,v];this.set_v_param("mididrum","MIDIdrum");break;case"program":if(a[3]!=undefined)v=a[3];else v=a[2];v=parseInt(v);if(isNaN(v)||v<0||v>127){this.syntax(1,"Bad program in %%MIDI");return}this.set_v_param("instr",v);break;case"control":n=parseInt(a[2]);if(isNaN(n)||n<0||n>127){this.syntax(1,"Bad controller number in %%MIDI");return}v=parseInt(a[3]);if(isNaN(v)||v<0||v>127){this.syntax(1,"Bad controller value in %%MIDI");return}this.set_v_param("midictl",a[2]+" "+a[3]);break}},set_midi:function(a){var i,item,curvoice=this.get_curvoice();for(i=0;i<a.length;i++){switch(a[i]){case"instr=":curvoice.instr=a[i+1];break;case"midictl=":if(!curvoice.midictl)curvoice.midictl={};item=a[i+1].split(" ");curvoice.midictl[item[0]]=Number(item[1]);break;case"mididrum=":if(!curvoice.map)curvoice.map={};curvoice.map=a[i+1];break}}},do_pscom:function(of,text){if(text.slice(0,5)=="MIDI ")abc2svg.MIDI.do_midi.call(this,text);else of(text)},set_vp:function(of,a){abc2svg.MIDI.set_midi.call(this,a);of(a)},set_hooks:function(abc){abc.do_pscom=abc2svg.MIDI.do_pscom.bind(abc,abc.do_pscom);abc.set_vp=abc2svg.MIDI.set_vp.bind(abc,abc.set_vp)}};abc2svg.modules.hooks.push(abc2svg.MIDI.set_hooks);abc2svg.modules.MIDI.loaded=true;
