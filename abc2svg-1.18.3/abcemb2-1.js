// abc2svg - ABC to SVG translator
// @source: https://chiselapp.com/user/moinejf/repository/abc2svg
// Copyright (C) 2014-2018 Jean-Francois Moine - LGPL3+
window.onerror=function(msg,url,line){if(typeof msg=="string")alert("window error: "+msg+"\nURL: "+url+"\nLine: "+line);else if(typeof msg=="object")alert("window error: "+msg.type+" "+msg.target.src);else alert("window error: "+msg);return false};var errtxt="",abc,elts,tunes="",indx=[],select,playing,abcplay,playconf={onend:endplay},a_pe=[],glop,old_gm,jsdir=document.currentScript?document.currentScript.src.match(/.*\//):function(){var scrs=document.getElementsByTagName("script");return scrs[scrs.length-1].src.match(/.*\//)||""}();var user={errmsg:function(msg,l,c){errtxt+=clean_txt(msg)+"\n"},img_out:function(str){new_page+=str},page_format:true};function clean_txt(txt){return txt.replace(/<|>|&.*?;|&/g,function(c){switch(c){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}return c})}function endplay(){playing=false}function playseq(i){var outputs;if(!abcplay){if(typeof AbcPlay=="undefined"){playseq=function(){};return}abcplay=AbcPlay(playconf);outputs=abcplay.get_outputs();if(outputs.length==0){playseq=function(){};return}}if(playing){abcplay.stop();return}playing=true;if(!a_pe[i]){abc=new abc2svg.Abc(user);abcplay.clear();abc.tosvg("play","%%play");if(select)abc.tosvg("abcemb2",select);try{if(glop!=undefined)abc.tosvg("abcemb2",tunes,indx[glop],indx[glop+1]);abc.tosvg("abcemb2-"+i,tunes,indx[i],indx[i+1])}catch(e){alert(e.message+"\nabc2svg tosvg bug - stack:\n"+e.stack);playing=false;a_pe[seq]=null;return}a_pe[i]=abcplay.clear()}abcplay.play(0,1e5,a_pe[i])}function dom_loaded(){if(typeof abc2svg!="object"||!abc2svg.modules){setTimeout(dom_loaded,500);return}function toabc(s){return s.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/[ \t]+(%%)/g,"$1").replace(/[ \t]+(.:)/g,"$1")}abc2svg.loadjs=function(fn,relay,onerror){var s=document.createElement("script");if(/:\/\//.test(fn))s.src=fn;else s.src=jsdir+fn;s.type="text/javascript";if(relay)s.onload=relay;s.onerror=onerror||function(){alert("error loading "+fn)};document.head.appendChild(s)};elts=document.getElementsByClassName("abc");for(var i=0;i<elts.length;i++){var elt=elts[i];indx[i]=tunes.length;tunes+=toabc(elt.innerHTML)+"\n"}indx[i]=tunes.length;ready()}function ready(){var i,j;if(!abc2svg.modules.load(tunes,ready))return;var sel=window.location.hash.slice(1);if(sel)select="%%select "+decodeURIComponent(sel);abc=new abc2svg.Abc(user);for(var i=0;i<elts.length;i++){new_page="";j=tunes.indexOf("X:",indx[i]);if(j>=0&&j<indx[i+1])new_page+='<div onclick="playseq('+i+')">\n';else if(glop==undefined)glop=i;if(sel){abc.tosvg("abcemb2",select);sel=""}try{abc.tosvg("abcemb2",tunes,indx[i],indx[i+1])}catch(e){alert("abc2svg javascript error: "+e.message+"\nStack:\n"+e.stack)}if(errtxt){new_page+='<p style="background:#ff8080">'+errtxt+"</p>\n";errtxt=""}try{elts[i].innerHTML=new_page}catch(e){alert("abc2svg bad generated SVG: "+e.message+"\nStack:\n"+e.stack)}if(j>=0&&j<indx[i+1])new_page+="</div>\n"}delete user.img_out;old_gm=user.get_abcmodel;user.get_abcmodel=function(tsfirst,voice_tb,music_types,info){if(old_gm)old_gm(tsfirst,voice_tb,music_types,info);abcplay.add(tsfirst,voice_tb)}}document.addEventListener("DOMContentLoaded",dom_loaded,false);
